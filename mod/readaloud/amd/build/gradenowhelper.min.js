define(["jquery","core/log","mod_readaloud/popoverhelper"],function(a,b,c){"use strict";return b.debug("Readaloud Gradenow helper: initialising"),{controls:{},currentmode:"grading",constants:{REVIEWMODE_NONE:0,REVIEWMODE_MACHINE:1,REVIEWMODE_HUMAN:2,REVIEWMODE_SCORESONLY:3},cd:{audioplayerclass:"mod_readaloud_grading_player",wordplayerclass:"mod_readaloud_hidden_player",wordclass:"mod_readaloud_grading_passageword",spaceclass:"mod_readaloud_grading_passagespace",badwordclass:"mod_readaloud_grading_badword",endspaceclass:"mod_readaloud_grading_endspace",unreadwordclass:"mod_readaloud_grading_unreadword",wpmscoreid:"mod_readaloud_grading_wpm_score",accuracyscoreid:"mod_readaloud_grading_accuracy_score",sessionscoreid:"mod_readaloud_grading_session_score",errorscoreid:"mod_readaloud_grading_error_score",formelementwpmscore:"mod_readaloud_grading_form_wpm",formelementaccuracy:"mod_readaloud_grading_form_accuracy",formelementsessionscore:"mod_readaloud_grading_form_sessionscore",formelementendword:"mod_readaloud_grading_form_sessionendword",formelementtime:"mod_readaloud_grading_form_sessiontime",formelementerrors:"mod_readaloud_grading_form_sessionerrors",modebutton:"mod_readaloud_modebutton",spotcheckbutton:"mod_readaloud_spotcheckbutton",transcriptcheckbutton:"mod_readaloud_transcriptcheckbutton",gradingbutton:"mod_readaloud_gradingbutton",clearbutton:"mod_readaloud_clearbutton",spotcheckmode:"mod_readaloud_spotcheckmode",aiunmatched:"mod_readaloud_aiunmatched",passagecontainer:"mod_readaloud_grading_passagecont"},options:{enabletts:!1,targetwpm:100,ttslanguage:"en",totalseconds:60,allowearlyexit:!1,timelimit:60,enforcemarker:!0,totalwordcount:0,wpm:0,accuracy:0,sessionscore:0,endwordnumber:0,errorwords:{},activityid:null,attemptid:null,sesskey:null,passagecontainer:"mod_readaloud_grading_passagecont"},init:function(c){var d="#"+c.id,e=a(d).get(0);if(!e)return void b.debug("Gradenow helper js: No config found on page. Giving up.");var f=JSON.parse(e.value);a(d).remove(),this.register_controls(),this.options.activityid=f.activityid,this.options.attemptid=f.attemptid,this.options.sesskey=f.sesskey,this.options.enabletts=f.enabletts,this.options.ttslanguage=f.ttslanguage,this.options.targetwpm=f.targetwpm,this.options.allowearlyexit=f.allowearlyexit,this.options.timelimit=f.timelimit,this.options.reviewmode=f.reviewmode,this.options.totalwordcount=a("."+this.cd.wordclass).length,f.sessiontime>0?(""!==f.sessionerrors?this.options.errorwords=JSON.parse(f.sessionerrors):this.options.errorwords={},this.options.totalseconds=f.sessiontime,this.options.endwordnumber=f.sessionendword,this.options.sessionscore=f.sessionscore,this.options.accuracy=f.accuracy,this.options.wpm=f.wpm,this.options.sessionmatches=JSON.parse(f.sessionmatches),this.options.aidata=f.aidata,this.options.aidata?this.options.transcriptwords=f.aidata.transcript.split(" "):this.options.transcriptwords=[],this.redrawgradestate()):this.options.endwordnumber=this.options.totalwordcount;var g=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber);g.addClass(this.cd.endspaceclass),this.register_events();var h=this,i=function(){h.options.allowearlyexit?h.options.totalseconds=Math.round(a("#"+h.cd.audioplayerclass).prop("duration")):h.options.totalseconds=h.options.timelimit,h.controls.formelementtime.val(h.options.totalseconds),h.processscores()},j=a("#"+this.cd.audioplayerclass);j.prop("readyState")<1&&this.options.allowearlyexit?j.on("loadedmetadata",i):i(),this.init_popoverhelper()},init_popoverhelper:function(){var b=this;c.onReject=function(){var d=a(this).attr("data-wordnumber"),e=d in b.options.errorwords;if(e)return void c.remove();for(var f=b.fetchPlayChain(d),g=f.startword;g<=f.endword;g++)if(!(g in b.options.errorwords)){var h=a("#"+b.cd.wordclass+"_"+g),i=a("#"+b.cd.spaceclass+"_"+g);b.adderrorword(g,h.text()),h.addClass(b.cd.badwordclass),h.addClass(b.cd.spotcheckmode),g!=f.endword&&i.addClass(b.cd.spotcheckmode)}b.markup_aiunmatchedspaces(),b.processscores(),c.remove()},c.onAccept=function(){var d=a(this).attr("data-wordnumber"),e=!(d in b.options.errorwords);if(e)return void c.remove();for(var f=b.fetchPlayChain(d),g=f.startword;g<=f.endword;g++)if(g in b.options.errorwords){delete b.options.errorwords[g];var h=a("#"+b.cd.wordclass+"_"+g),i=a("#"+b.cd.spaceclass+"_"+g);h.removeClass(b.cd.badwordclass),h.removeClass(b.cd.spotcheckmode),i.removeClass(b.cd.spotcheckmode)}b.markup_aiunmatchedspaces(),b.processscores(),c.remove()},c.init()},register_controls:function(){this.controls.wordplayer=a("#"+this.cd.wordplayerclass),this.controls.audioplayer=a("#"+this.cd.audioplayerclass),this.controls.eachword=a("."+this.cd.wordclass),this.controls.eachspace=a("."+this.cd.spaceclass),this.controls.endwordmarker=a("#"+this.cd.spaceclass+"_"+this.options.endwordnumber),this.controls.spotcheckword=a("."+this.cd.spotcheckmode),this.controls.wpmscorebox=a("#"+this.cd.wpmscoreid),this.controls.accuracyscorebox=a("#"+this.cd.accuracyscoreid),this.controls.sessionscorebox=a("#"+this.cd.sessionscoreid),this.controls.errorscorebox=a("#"+this.cd.errorscoreid),this.controls.formelementwpmscore=a("#"+this.cd.formelementwpmscore),this.controls.formelementsessionscore=a("#"+this.cd.formelementsessionscore),this.controls.formelementaccuracy=a("#"+this.cd.formelementaccuracy),this.controls.formelementendword=a("#"+this.cd.formelementendword),this.controls.formelementerrors=a("#"+this.cd.formelementerrors),this.controls.formelementtime=a("#"+this.cd.formelementtime),this.controls.passagecontainer=a("."+this.cd.passagecontainer),this.controls.modebutton=a("#"+this.cd.modebutton),this.controls.gradingbutton=a("#"+this.cd.gradingbutton),this.controls.spotcheckbutton=a("#"+this.cd.spotcheckbutton),this.controls.transcriptcheckbutton=a("#"+this.cd.transcriptcheckbutton),this.controls.clearbutton=a("#"+this.cd.clearbutton)},register_events:function(){var b=this;this.controls.passagecontainer.on("click","."+this.cd.spotcheckmode+", ."+this.cd.aiunmatched,function(){if("spotcheck"==b.currentmode){var c=parseInt(a(this).attr("data-wordnumber"));b.doPlaySpotCheck(c)}}),this.options.reviewmode==this.constants.REVIEWMODE_MACHINE?(this.options.sessionmatches&&this.doSpotCheckMode(),this.controls.eachword.click(function(){if("spotcheck"!=b.currentmode){var d=a(this).attr("data-wordnumber");a(this).text();if("transcriptcheck"==b.currentmode){var e=b.fetchTranscriptChunk(d);return void(e&&c.addTranscript(this,e))}}})):(this.controls.eachword.click(function(){var d=a(this).attr("data-wordnumber"),e=a(this).text();if("spotcheck"==b.currentmode)return void((a(this).hasClass(b.cd.badwordclass)||a(this).hasClass(b.cd.aiunmatched))&&c.addQuickGrader(this));if("transcriptcheck"==b.currentmode){var f=b.fetchTranscriptChunk(d);return void(f&&c.addTranscript(this,f))}b.options.enforcemarker&&Number(d)>Number(b.options.endwordnumber)||(d in b.options.errorwords?(delete b.options.errorwords[d],a(this).removeClass(b.cd.badwordclass)):(b.adderrorword(d,e),a(this).addClass(b.cd.badwordclass)),b.processscores())}),this.controls.eachspace.click(function(){if("spotcheck"!=b.currentmode&&"transcriptcheck"!=b.currentmode){var c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);c==b.options.endwordnumber?(b.options.endwordnumber=b.options.totalwordcount,d.removeClass(b.cd.endspaceclass),a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)):(a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass),b.options.endwordnumber=c,d.addClass(b.cd.endspaceclass)),b.processunread(),b.processscores()}}),this.controls.clearbutton.click(function(){"spotcheck"!=b.currentmode&&"transcriptcheck"!=b.currentmode&&(a("."+b.cd.badwordclass).each(function(c){var d=a(this).attr("data-wordnumber");delete b.options.errorwords[d],a(this).removeClass(b.cd.badwordclass)}),a("."+b.cd.wordclass).removeClass(b.cd.unreadwordclass),b.options.endwordnumber=b.options.totalwordcount,a("."+b.cd.spaceclass).removeClass(b.cd.endspaceclass),a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass),b.processscores())}),this.controls.gradingbutton.click(function(){b.undoCurrentMode(),b.doGradingMode(),b.updateButtonStates()})),this.controls.spotcheckbutton.click(function(){b.undoCurrentMode(),b.doSpotCheckMode(),b.updateButtonStates()}),this.controls.transcriptcheckbutton.click(function(){b.undoCurrentMode(),b.doTranscriptCheckMode(),b.updateButtonStates()})},undoCurrentMode:function(){switch(this.currentmode){case"grading":break;case"spotcheck":this.undoSpotCheckMode();break;case"transcriptcheck":this.undoTranscriptCheckMode()}},updateButtonStates:function(){switch(this.currentmode){case"grading":this.controls.gradingbutton.prop("disabled",!0),this.controls.spotcheckbutton.prop("disabled",!1),this.controls.transcriptcheckbutton.prop("disabled",!1);break;case"spotcheck":this.controls.gradingbutton.prop("disabled",!1),this.controls.spotcheckbutton.prop("disabled",!0),this.controls.transcriptcheckbutton.prop("disabled",!1);break;case"transcriptcheck":this.controls.gradingbutton.prop("disabled",!1),this.controls.spotcheckbutton.prop("disabled",!1),this.controls.transcriptcheckbutton.prop("disabled",!0)}},doPlaySpotCheck:function(b){var c=this.fetchPlayChain(b),d=this.controls.audioplayer[0];d.currentTime=c.audiostart,a(this.controls.audioplayer).off("timeupdate"),a(this.controls.audioplayer).on("timeupdate",function(b){var e=d.currentTime;e>=c.audioend&&(a(this).off("timeupdate"),d.pause())}),d.play()},fetchPlayChain:function(b){for(var c=b,d=-1,e=b;e>0;e--){var f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.badwordclass),g=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(!f&&!g)break;c=e,d=g?-1:this.options.sessionmatches[""+e].audiostart}if(d==-1){d=0;for(var e=c-1;e>0;e--)if(this.options.sessionmatches[""+e]){d=this.options.sessionmatches[""+e].audioend;break}}for(var h=b,i=-1,j=this.options.totalwordcount,e=b;e<=j;e++){var f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.badwordclass),g=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(!f&&!g)break;h=e,i=g?-1:this.options.sessionmatches[""+e].audioend}if(i==-1){i=this.options.totalseconds;for(var e=h+1;e<=j;e++)if(this.options.sessionmatches[""+e]){i=this.options.sessionmatches[""+e].audiostart;break}}var k={};return k.startword=c,k.endword=h,k.audiostart=d,k.audioend=i,k},doSpotCheckMode:function(){this.markup_aiunmatchedwords(),a("."+this.cd.badwordclass).addClass(this.cd.spotcheckmode),this.markup_aiunmatchedspaces(),this.currentmode="spotcheck"},markup_aiunmatchedwords:function(){var b=this;if(this.options.sessionmatches){var c=0;a.each(this.options.sessionmatches,function(d,e){var f=d-c-1;if(f>0)for(var g=1;g<f+1;g++){var h=c+g;a("#"+b.cd.wordclass+"_"+h).addClass(b.cd.aiunmatched)}c=parseInt(d)});for(var d=c+1;d<=this.options.endwordnumber;d++){var e=d;a("#"+b.cd.wordclass+"_"+e).addClass(b.cd.aiunmatched)}}},markup_badspaces:function(){var b=this;a("."+this.cd.badwordclass+"."+this.cd.spotcheckmode).each(function(c){var d=parseInt(a(this).attr("data-wordnumber"));(a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.spotcheckmode)||a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.aiunmatched))&&a("#"+b.cd.spaceclass+"_"+d).addClass(b.cd.spotcheckmode)})},markup_aiunmatchedspaces:function(){var b=this;a("."+this.cd.wordclass+"."+this.cd.aiunmatched).each(function(c){var d=parseInt(a(this).attr("data-wordnumber"));(a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.spotcheckmode)||a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.aiunmatched))&&a("#"+b.cd.spaceclass+"_"+d).addClass(b.cd.aiunmatched)})},undoSpotCheckMode:function(){a("."+this.cd.badwordclass).removeClass(this.cd.spotcheckmode),a("."+this.cd.spaceclass).removeClass(this.cd.spotcheckmode),a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched),a(this.controls.audioplayer).off("timeupdate"),c.remove()},doTranscriptCheckMode:function(){var b=this;if(this.options.sessionmatches){var c=0;a.each(this.options.sessionmatches,function(d,e){var f=d-c-1;if(f>0)for(var g=1;g<f+1;g++){var h=c+g;a("#"+b.cd.wordclass+"_"+h).addClass(b.cd.aiunmatched)}c=parseInt(d)});for(var d=c+1;d<=this.options.endwordnumber;d++){var e=d;a("#"+b.cd.wordclass+"_"+e).addClass(b.cd.aiunmatched)}}a("."+this.cd.aiunmatched).each(function(c){var d=parseInt(a(this).attr("data-wordnumber"));a("#"+b.cd.wordclass+"_"+(d+1)).hasClass(b.cd.aiunmatched)&&a("#"+b.cd.spaceclass+"_"+d).addClass(b.cd.aiunmatched)}),this.currentmode="transcriptcheck"},undoTranscriptCheckMode:function(){a("."+this.cd.wordclass).removeClass(this.cd.aiunmatched),a("."+this.cd.spaceclass).removeClass(this.cd.aiunmatched),c.remove()},doGradingMode:function(){this.currentmode="grading"},fetchTranscriptChunk:function(b){var c=this.options.transcriptwords.length;if(0==c)return"";for(var d=-1,e=b;e>0;e--){var f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(!f){d=this.options.sessionmatches[""+e].tposition+1;break}}for(var g=-1,e=b;e<=c;e++){var f=a("#"+this.cd.wordclass+"_"+e).hasClass(this.cd.aiunmatched);if(!f){g=this.options.sessionmatches[""+e].tposition-1;break}}if(d==-1&&(d=1),g==c)g=-1;else if(0==g||g<d)return!1;d--;var h=!1;return h=g>0?this.options.transcriptwords.slice(d,g).join(" "):this.options.transcriptwords.slice(d).join(" "),""!=h.trim()&&h},playword:function(){var b=this;b.controls.wordplayer.attr("src",M.cfg.wwwroot+"/mod/readaloud/tts.php?txt="+encodeURIComponent(a(this).text())+"&lang="+b.options.ttslanguage+"&n="+b.options.activityid),b.controls.wordplayer[0].pause(),b.controls.wordplayer[0].load(),b.controls.wordplayer[0].play()},redrawgradestate:function(){var b=this;this.processunread(),a.each(b.options.errorwords,function(c){a("#"+b.cd.wordclass+"_"+b.options.errorwords[c].wordnumber).addClass(b.cd.badwordclass)})},adderrorword:function(a,b){this.options.errorwords[a]={word:b,wordnumber:a}},processword:function(){var b=this,c=a(this).attr("data-wordnumber"),d=a(this).text();b.options.enforcemarker&&Number(c)>Number(b.options.endwordnumber)||(c in b.options.errorwords?(delete b.options.errorwords[c],a(this).removeClass(b.cd.badwordclass)):(b.adderrorword(c,d),a(this).addClass(b.cd.badwordclass)),b.processscores())},processspace:function(){var b=this,c=a(this).attr("data-wordnumber"),d=a("#"+b.cd.spaceclass+"_"+c);c==b.options.endwordnumber?(b.options.endwordnumber=b.options.totalwordcount,d.removeClass(b.cd.endspaceclass),a("#"+b.cd.spaceclass+"_"+b.options.totalwordcount).addClass(b.cd.endspaceclass)):(a("#"+b.cd.spaceclass+"_"+b.options.endwordnumber).removeClass(b.cd.endspaceclass),b.options.endwordnumber=c,d.addClass(b.cd.endspaceclass)),b.processunread(),b.processscores()},processunread:function(){var b=this;b.controls.eachword.each(function(c){var d=a(this).attr("data-wordnumber");Number(d)>Number(b.options.endwordnumber)?(a(this).addClass(b.cd.unreadwordclass),b.options.enforcemarker&&d in b.options.errorwords&&(delete b.options.errorwords[d],a(this).removeClass(b.cd.badwordclass))):a(this).removeClass(b.cd.unreadwordclass)})},processscores:function(){var a=this,b=Object.keys(a.options.errorwords).length;a.controls.errorscorebox.text(b);var c=Math.round(60*(a.options.endwordnumber-b)/a.options.totalseconds);a.options.wpm=c,a.controls.wpmscorebox.text(c);var d=Math.round((a.options.endwordnumber-b)/a.options.endwordnumber*100);a.options.accuracy=d,a.controls.accuracyscorebox.text(d);var e=c;e>a.options.targetwpm&&(e=a.options.targetwpm);var f=Math.round(e/a.options.targetwpm*100);a.controls.sessionscorebox.text(f),a.controls.formelementwpmscore.val(c),a.controls.formelementsessionscore.val(f),a.controls.formelementaccuracy.val(d),a.controls.formelementendword.val(a.options.endwordnumber),a.controls.formelementerrors.val(JSON.stringify(a.options.errorwords))}}});